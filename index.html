<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Snack Bar: Accurate Tycoon</title>
    <style>
        :root {
            --kitchen-bg: #ffe8d6;
            --floor-bg: #ddbea9;
            --counter-color: #6b705c;
            --ui-bg: #fff;
            --accent: #cb997e;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #222;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #app {
            width: 100%;
            max-width: 500px;
            background-color: var(--floor-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* HUD */
        #header {
            background: var(--ui-bg);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #aaa;
            z-index: 100;
        }
        .stat { font-weight: bold; font-size: 1.1rem; }

        /* GAME WORLD */
        #game-layer {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        /* ZONES */
        .zone-kitchen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 200px;
            background: var(--kitchen-bg);
            border-bottom: 10px solid var(--counter-color);
            box-sizing: border-box;
        }

        .counter-surface {
            position: absolute;
            top: 190px; left: 0; width: 100%; height: 10px;
            z-index: 20;
        }

        /* ENTITIES */
        .entity {
            position: absolute;
            width: 40px; height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            transition: top 0.1s linear, left 0.1s linear;
            z-index: 10;
        }
        
        .station {
            position: absolute;
            width: 60px; height: 60px;
            background: #a5a58d;
            border: 2px solid #6b705c;
            border-radius: 8px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: 1.5rem;
        }
        .station-lvl { font-size: 10px; background: #333; color: white; padding: 1px 4px; border-radius: 4px; margin-top: -5px; }

        .table {
            position: absolute;
            width: 50px; height: 50px;
            background: #b7b7a4;
            border-radius: 50%;
            border: 2px solid #6b705c;
        }

        /* BUBBLES */
        .bubble {
            position: absolute;
            top: -25px;
            background: white;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid #333;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
        }

        /* BOTTOM UI */
        #controls {
            height: 250px;
            background: var(--ui-bg);
            border-top: 2px solid #ccc;
            display: flex;
            flex-direction: column;
            z-index: 200;
        }
        
        #tabs { display: flex; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #eee; }
        .tab.active { background: #fff; font-weight: bold; border-bottom: 3px solid var(--accent); }
        
        #panel-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        .upgrade-row {
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa; border: 1px solid #ddd; padding: 8px; margin-bottom: 8px; border-radius: 6px;
        }
        .btn {
            background: var(--accent); color: white; border: none; padding: 6px 12px;
            border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .btn.disabled { opacity: 0.5; pointer-events: none; background: #999; }
        .btn.maxed { background: #2a9d8f; }

        /* Floating Text */
        .float-money {
            position: absolute; color: #2a9d8f; font-weight: bold; font-size: 14px;
            animation: floatUp 1s forwards; z-index: 999;
        }
        @keyframes floatUp { to { transform: translateY(-40px); opacity: 0; } }

    </style>
</head>
<body>

<div id="app">
    <div id="header">
        <div class="stat">üíé <span id="gems">0</span></div>
        <div style="font-size:0.9rem">STAGE 1: SANDWICH SHOP</div>
        <div class="stat">ü¶¥ <span id="money">0</span></div>
    </div>

    <div id="game-layer">
        <div class="zone-kitchen"></div>
        <div class="counter-surface"></div>
        
        </div>

    <div id="controls">
        <div id="tabs">
            <div class="tab active" onclick="setTab('menu')">Menu</div>
            <div class="tab" onclick="setTab('staff')">Staff</div>
            <div class="tab" onclick="setTab('shop')">Shop</div>
        </div>
        <div id="panel-content">
            </div>
    </div>
</div>

<script>
/**
 * DOG SNACK BAR: EXACT MECHANICS
 * * Core Loop:
 * 1. Customer enters -> Sits at Table.
 * 2. Order Bubble appears over Customer.
 * 3. Chef (Kitchen) sees order -> Walks to Station -> Cooks -> Places food on Counter.
 * 4. Server (Floor) sees food on Counter -> Walks to Counter -> Picks up -> Walks to Table.
 * 5. Customer eats (timer) -> Leaves Money -> Leaves.
 */

// --- CONFIGURATION ---

const STATIONS = [
    { id: 0, name: "Juice", emoji: "üßÉ", basePrice: 10, baseTime: 1000, x: 50, y: 50 },
    { id: 1, name: "Donut", emoji: "üç©", basePrice: 250, baseTime: 3000, x: 180, y: 50 },
    { id: 2, name: "Sandwich", emoji: "ü•™", basePrice: 1000, baseTime: 5000, x: 310, y: 50 }
];

const TABLES = [
    { id: 0, x: 80, y: 250 },
    { id: 1, x: 220, y: 250 },
    { id: 2, x: 360, y: 250 },
    { id: 3, x: 150, y: 350 },
    { id: 4, x: 290, y: 350 }
];

const MILESTONES = [10, 25, 50, 75, 100]; // Levels where price multiplies
const MILESTONE_MULTS = [2, 2, 2, 3, 5];  // The multipliers

// --- STATE ---

let state = {
    money: 10,
    gems: 0,
    stationLevels: [1, 0, 0], // Level 0 means locked
    chefs: [{id:0, x:50, y:120, state:'IDLE'}], // Starts with 1 Chef
    servers: [], // Starts with 0 Servers (Chef does all if empty? No, guide says Part Timer needed usually, but we will make Chef serve if no servers)
    inventory: [] // Costumes
};

// Runtime arrays
let customers = []; 
let activeOrders = []; // { tableId, stationId, status: 'PENDING' | 'COOKING' | 'READY' | 'SERVED' }
let foodOnCounter = []; // { stationId, x, y }
let floatingTexts = [];

// DOM Cache
const gameLayer = document.getElementById('game-layer');
const moneyEl = document.getElementById('money');
const gemsEl = document.getElementById('gems');
const panel = document.getElementById('panel-content');

let currentTab = 'menu';

// --- INITIALIZATION ---

function init() {
    renderStaticWorld();
    gameLoop();
    uiLoop();
    setInterval(spawnCustomer, 2500);
}

function renderStaticWorld() {
    // Render Stations
    STATIONS.forEach((st, idx) => {
        let el = document.createElement('div');
        el.className = 'station';
        el.style.left = st.x + 'px';
        el.style.top = st.y + 'px';
        el.id = `station-${idx}`;
        el.innerHTML = `<div>${st.emoji}</div><div class="station-lvl" id="lvl-${idx}">Lvl ${state.stationLevels[idx]}</div>`;
        if(state.stationLevels[idx] === 0) el.style.opacity = '0.5';
        gameLayer.appendChild(el);
    });

    // Render Tables
    TABLES.forEach((tbl, idx) => {
        let el = document.createElement('div');
        el.className = 'table';
        el.style.left = tbl.x + 'px';
        el.style.top = tbl.y + 'px';
        gameLayer.appendChild(el);
    });
    
    // Render Staff (Initial)
    updateStaffVisuals();
}

// --- GAME LOOP ---

function gameLoop() {
    updateLogic();
    requestAnimationFrame(gameLoop);
}

function updateLogic() {
    // 1. CHEF LOGIC
    state.chefs.forEach(chef => {
        if(chef.state === 'IDLE') {
            // Find a PENDING order for an unlocked station
            let job = activeOrders.find(o => o.status === 'PENDING' && state.stationLevels[o.stationId] > 0 && !o.chefAssigned);
            if(job) {
                job.chefAssigned = true;
                chef.state = 'MOVING_TO_STATION';
                chef.targetJob = job;
                let st = STATIONS[job.stationId];
                moveTo(chef, st.x, st.y + 60, () => {
                    chef.state = 'COOKING';
                    // Cooking Timer
                    setTimeout(() => {
                        // Cook Done
                        chef.state = 'MOVING_TO_COUNTER';
                        // Counter is at y=180 roughly
                        moveTo(chef, chef.x, 170, () => {
                            // Place Food
                            spawnFoodOnCounter(job);
                            job.status = 'READY';
                            chef.state = 'IDLE';
                            chef.targetJob = null;
                        });
                    }, 500); // Fast cooking for demo, real game uses st.baseTime
                });
            } else if (state.servers.length === 0) {
                // FALLBACK: If no servers, Chef also serves (Solo Mode)
                let readyFood = activeOrders.find(o => o.status === 'READY' && !o.serverAssigned);
                if(readyFood) {
                    readyFood.serverAssigned = true;
                    chef.state = 'SERVING_PICKUP';
                    moveTo(chef, chef.x, 170, () => {
                        chef.state = 'SERVING_DELIVER';
                        let tbl = TABLES[readyFood.tableId];
                        // Pick up visual (attach food to chef)
                        removeFoodVisual(readyFood); 
                        moveTo(chef, tbl.x, tbl.y - 40, () => {
                            // Delivered
                            serveCustomer(readyFood);
                            chef.state = 'IDLE';
                        });
                    });
                }
            }
        }
        updateEntityPosition(chef);
    });

    // 2. SERVER LOGIC
    state.servers.forEach(server => {
        if(server.state === 'IDLE') {
            // Look for READY food
            let job = activeOrders.find(o => o.status === 'READY' && !o.serverAssigned);
            if(job) {
                job.serverAssigned = true;
                server.state = 'MOVING_TO_COUNTER';
                // Find where the food is visually? 
                // For simplicity, move to general counter area near station
                let st = STATIONS[job.stationId];
                moveTo(server, st.x, 200, () => {
                    // Pick up
                    removeFoodVisual(job);
                    server.state = 'DELIVERING';
                    let tbl = TABLES[job.tableId];
                    moveTo(server, tbl.x, tbl.y - 40, () => {
                        serveCustomer(job);
                        server.state = 'IDLE';
                    });
                });
            }
        }
        updateEntityPosition(server);
    });

    // 3. CUSTOMER LOGIC
    customers.forEach(c => {
        updateEntityPosition(c);
    });
}

// --- ENTITY HELPERS ---

function moveTo(entity, tx, ty, callback) {
    entity.targetX = tx;
    entity.targetY = ty;
    entity.onReach = callback;
    entity.moving = true;
}

function updateEntityPosition(ent) {
    if(!ent.el) {
        // Create DOM if missing
        let el = document.createElement('div');
        el.className = 'entity';
        el.innerText = ent.emoji || (ent.type === 'chef' ? 'üë®‚Äçüç≥' : (ent.type === 'server' ? 'üêï' : 'üê∂'));
        if(ent.type === 'chef') el.style.backgroundColor = '#fff';
        if(ent.type === 'server') el.style.backgroundColor = '#8ecae6';
        el.style.borderRadius = '50%';
        el.style.border = '1px solid #000';
        gameLayer.appendChild(el);
        ent.el = el;
        // Force init pos
        ent.el.style.left = ent.x + 'px';
        ent.el.style.top = ent.y + 'px';
    }

    if(ent.moving) {
        let dx = ent.targetX - ent.x;
        let dy = ent.targetY - ent.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        let speed = 4; // Movement speed

        if(dist <= speed) {
            ent.x = ent.targetX;
            ent.y = ent.targetY;
            ent.moving = false;
            if(ent.onReach) {
                let cb = ent.onReach;
                ent.onReach = null;
                cb();
            }
        } else {
            ent.x += (dx/dist) * speed;
            ent.y += (dy/dist) * speed;
        }
        ent.el.style.left = ent.x + 'px';
        ent.el.style.top = ent.y + 'px';
        ent.el.style.zIndex = Math.floor(ent.y); // Depth sort
    }
}

// --- GAMEPLAY EVENTS ---

function spawnCustomer() {
    // Find empty table
    let occupiedTables = customers.map(c => c.tableId);
    let freeTables = TABLES.filter(t => !occupiedTables.includes(t.id));
    
    if(freeTables.length > 0 && customers.length < 5) {
        let table = freeTables[Math.floor(Math.random() * freeTables.length)];
        let c = {
            x: 200, y: 600, // Start off screen bottom
            targetX: table.x, targetY: table.y - 20,
            tableId: table.id,
            state: 'WALKING_IN',
            type: 'customer',
            emoji: ["üê∂","üêï","üê©"][Math.floor(Math.random()*3)]
        };
        
        customers.push(c);
        
        moveTo(c, c.targetX, c.targetY, () => {
            // Sat down
            c.state = 'SITTING';
            generateOrder(c);
        });
    }
}

function generateOrder(customer) {
    // Pick unlocked station
    let unlocked = state.stationLevels.map((l, i) => l > 0 ? i : -1).filter(i => i !== -1);
    if(unlocked.length === 0) return; // Should not happen

    let stationId = unlocked[Math.floor(Math.random() * unlocked.length)];
    
    // Show Bubble
    let bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerText = STATIONS[stationId].emoji;
    customer.el.appendChild(bubble);
    customer.bubble = bubble;

    activeOrders.push({
        customer: customer,
        tableId: customer.tableId,
        stationId: stationId,
        status: 'PENDING',
        chefAssigned: false,
        serverAssigned: false
    });
}

function spawnFoodOnCounter(job) {
    let st = STATIONS[job.stationId];
    let el = document.createElement('div');
    el.className = 'entity';
    el.style.width = '20px'; el.style.height = '20px';
    el.style.fontSize = '16px';
    el.innerText = st.emoji;
    el.style.left = st.x + 'px';
    el.style.top = '190px'; // Counter height
    gameLayer.appendChild(el);
    job.foodEl = el;
}

function removeFoodVisual(job) {
    if(job.foodEl) {
        job.foodEl.remove();
        job.foodEl = null;
    }
}

function serveCustomer(job) {
    // Customer eats
    if(job.customer.bubble) job.customer.bubble.innerText = "üòã";
    
    setTimeout(() => {
        // Finished eating, Pay money
        let revenue = calculatePrice(job.stationId);
        addMoney(revenue);
        
        // Float Text
        let ft = document.createElement('div');
        ft.className = 'float-money';
        ft.innerText = `+${formatMoney(revenue)}`;
        ft.style.left = job.customer.x + 'px';
        ft.style.top = job.customer.y + 'px';
        gameLayer.appendChild(ft);
        setTimeout(()=>ft.remove(), 1000);

        // Leave
        let c = job.customer;
        c.bubble.remove();
        moveTo(c, 250, 600, () => {
            c.el.remove();
            customers = customers.filter(cust => cust !== c);
        });

        // Remove order
        activeOrders = activeOrders.filter(o => o !== job);

    }, 1000); // Eating time
}

// --- ECONOMY ---

function calculatePrice(stationId) {
    let level = state.stationLevels[stationId];
    let base = STATIONS[stationId].basePrice;
    
    // Calculate Multiplier based on Milestones
    let multiplier = 1;
    let milestoneAccum = 1;
    
    // Simple geometric growth for level
    let levelGrow = level; 

    // Check milestones (Wiki Mechanics: x2 at lvl 10, x2 at 25 etc)
    MILESTONES.forEach((m, i) => {
        if(level >= m) milestoneAccum *= MILESTONE_MULTS[i];
    });

    return Math.floor(base * levelGrow * milestoneAccum);
}

function getUpgradeCost(stationId) {
    let level = state.stationLevels[stationId];
    let base = STATIONS[stationId].basePrice;
    if(level === 0) return base; // Unlock cost
    
    // Cost curve
    return Math.floor(base * Math.pow(1.6, level));
}

function addMoney(amount) {
    state.money += amount;
    moneyEl.innerText = formatMoney(state.money);
    uiLoop(); // Update buttons immediately
}

function formatMoney(num) {
    if(num >= 1000000) return (num/1000000).toFixed(2) + 'm';
    if(num >= 1000) return (num/1000).toFixed(1) + 'k';
    return num;
}

// --- UI & CONTROLS ---

function setTab(t) {
    currentTab = t;
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.querySelector(`.tab[onclick="setTab('${t}')"]`).forEach(el => el.classList.add('active')); // Note: simple selector hack
    uiLoop();
}
// Fix tab selector
document.querySelectorAll('.tab').forEach(el => {
    el.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        this.classList.add('active');
    });
});

function uiLoop() {
    panel.innerHTML = '';
    
    if(currentTab === 'menu') {
        STATIONS.forEach((st, idx) => {
            let lvl = state.stationLevels[idx];
            let cost = getUpgradeCost(idx);
            let revenue = lvl > 0 ? calculatePrice(idx) : 0;
            
            // Check for next milestone
            let nextMilestone = MILESTONES.find(m => m > lvl);
            let milestoneText = nextMilestone ? `x${MILESTONE_MULTS[MILESTONES.indexOf(nextMilestone)]} at Lvl ${nextMilestone}` : "MAX";
            
            let div = document.createElement('div');
            div.className = 'upgrade-row';
            
            let btnClass = state.money >= cost ? 'btn' : 'btn disabled';
            let btnText = lvl === 0 ? 'Unlock' : 'Level Up';
            
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold">${st.emoji} ${st.name} <span style="font-size:0.8rem; color:#666">Lvl ${lvl}</span></div>
                    <div style="font-size:0.8rem; color:#2a9d8f">Earn: ${formatMoney(revenue)} ü¶¥ <span style="color:#e76f51">(${milestoneText})</span></div>
                </div>
                <button class="${btnClass}" onclick="upgradeStation(${idx})">
                    ${btnText} <br> ${formatMoney(cost)}
                </button>
            `;
            panel.appendChild(div);
        });
    } else if (currentTab === 'staff') {
        // Hire Part Timer
        let serverCost = (state.servers.length + 1) * 5000;
        let hireBtn = state.money >= serverCost ? 'btn' : 'btn disabled';
        
        let div = document.createElement('div');
        div.className = 'upgrade-row';
        div.innerHTML = `
            <div>
                <b>Hire Part-Timer</b><br>
                <small>Carries food to tables</small>
            </div>
            <button class="${hireBtn}" onclick="hireServer(${serverCost})">Hire ${formatMoney(serverCost)}</button>
        `;
        panel.appendChild(div);
        
        let info = document.createElement('div');
        info.innerHTML = `<p>Current Staff:<br>üë®‚Äçüç≥ Chefs: ${state.chefs.length}<br>üêï Servers: ${state.servers.length}</p>`;
        panel.appendChild(info);
    } else if (currentTab === 'shop') {
        panel.innerHTML = '<div style="text-align:center; padding:20px; color:#777">Store coming in Stage 2</div>';
    }
}

function upgradeStation(idx) {
    let cost = getUpgradeCost(idx);
    if(state.money >= cost) {
        state.money -= cost;
        state.stationLevels[idx]++;
        
        // Update visual level tag
        let tag = document.getElementById(`lvl-${idx}`);
        if(tag) tag.innerText = `Lvl ${state.stationLevels[idx]}`;
        
        // Update opacity if unlocked
        if(state.stationLevels[idx] === 1) {
            document.getElementById(`station-${idx}`).style.opacity = '1';
        }
        
        addMoney(0); // Refresh UI
    }
}

function hireServer(cost) {
    if(state.money >= cost) {
        state.money -= cost;
        // Spawn server
        let s = { x: 100, y: 150, state: 'IDLE', type: 'server' };
        state.servers.push(s);
        updateStaffVisuals();
        addMoney(0);
    }
}

function updateStaffVisuals() {
    // Only needed if we want to redraw them, but updateEntityPosition handles creation
}

// Start
init();

</script>
</body>
</html>
